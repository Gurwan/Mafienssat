{% extends 'main.html' %}
{% block content %}
{% load static %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% include 'nav.html' %}
<div class="container-fluid" id="betklax-pages">
    <h2>Ton pocheton de klaxcoins</h2>
      {% if user.klax_coins > 0 %}
          <div>
              <p><span>Tododododoo...</span> tu as {{ user.klax_coins }} <span id="yellow-span">klaxcoins</span></p>
          </div>
      {% else %}
          <div>
            <p><span>Time to soudoyer</span> car là tu n'as aucun <span id="yellow-span">klaxcoin</span> à parier (tema la bete de phrase)</p>
          </div>
      {% endif %}
</div>

<div class="container-fluid" id="betklax-pages">
    <h1 style="text-align: center; margin-top:20px">Tous les paris</h1>
    {% for bet in bets %}
        <div class="div-du-bet">
            <h3>{{ bet.bet_name }}</h3>
            <h4>Fini le {{bet.ended | date:"d"}} {{bet.ended  | date:"F"}} {{bet.ended  | date:"o"}} à {{bet.ended | date:"H"}}h{{bet.ended | date:"i"}}</h4>
            {% if request.user.is_authenticated %}
                <button class="button_rate" type="submit" id="w-{{ bet.id }}" onclick="makeBet(this.id)" value="makeBetW" name="makeBetW">
                    <p id="label">Oui</p>
                    <p id="rate">{{ bet.win_rate }}</p>
                </button>
                <button class="button_rate" type="submit" id="l-{{ bet.id }}" onclick="makeBet(this.id)" value="makeBetL" name="makeBetL">
                    <p id="label">Non</p>
                    <p id="rate">{{ bet.lose_rate }}</p>
                </button>
            {% else %}
                <div class="button_rate">
                    <p id="label">Oui</p>
                    <p id="rate">{{ bet.win_rate }}</p>
                </div>
                <div class="button_rate">
                    <p id="label">Non</p>
                    <p id="rate">{{ bet.lose_rate }}</p>
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>
<script>
    function ratingRecalculation(id){
        const data = new FormData();
        data.append('csrfmiddlewaretoken', "{{ csrf_token }}");
        data.append('name', 'myBets');
        data.append('bet', id.split("-")[1])
        fetch('{% url "ratingRecalculation" %}', {
                method: 'POST',
                body: data
            })
    }
    function makeBet(id){
        const data = new FormData();
        data.append('csrfmiddlewaretoken', "{{ csrf_token }}");
        data.append('bet',id.split("-")[1]);
        if(id.split("-")[0] === "w"){
                fetch('{% url "makeBetW" %}', {
                    method: 'POST',
                    body: data
                })
            } else {
                fetch('{% url "makeBetL" %}', {
                    method: 'POST',
                    body: data
                })
            }
        //location.reload();
        ratingRecalculation(id);
    }
</script>
{% endblock %}